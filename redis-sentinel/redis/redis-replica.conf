# =============================================================================
# Redis Replica Configuration for KasagiEngine
# =============================================================================
# This configuration is for Redis replica nodes.
# Replicas automatically sync from the master and can be promoted during failover.
# =============================================================================

# -----------------------------------------------------------------------------
# NETWORK CONFIGURATION
# -----------------------------------------------------------------------------

# Bind to all interfaces (required for Docker networking)
bind 0.0.0.0

# Standard Redis port (mapped differently in docker-compose)
port 6379

# Disable protected mode for Docker internal networking
protected-mode no

# TCP backlog for high connection scenarios
tcp-backlog 511

# Client timeout (0 = no timeout, keeps connections alive)
timeout 0

# TCP keepalive interval
tcp-keepalive 300

# -----------------------------------------------------------------------------
# GENERAL SETTINGS
# -----------------------------------------------------------------------------

# Run in foreground for Docker
daemonize no

# Docker supervision mode
supervised no

# PID file location
pidfile /var/run/redis/redis-server.pid

# Logging level
loglevel notice

# Log to stdout for Docker
logfile ""

# Number of databases
databases 16

# Disable startup logo
always-show-logo no

# -----------------------------------------------------------------------------
# REPLICATION SETTINGS (REPLICA-SPECIFIC)
# -----------------------------------------------------------------------------
# This is the key section that makes this node a replica.

# IMPORTANT: Master hostname and port
# The replica will connect to this master and sync data
# In Docker, we use the container hostname
replicaof redis-master 6379

# Master authentication (if master requires password)
# masterauth <master-password>

# Replica authentication (if using ACL)
# masteruser <username>

# Serve stale data while syncing with master
# 'yes' = continue serving (possibly stale) data during sync
# 'no' = return error until sync completes
# For real-time systems, 'yes' provides better availability
replica-serve-stale-data yes

# Replica is read-only (recommended)
# Writes should go to master only
replica-read-only yes

# Use diskless replication for faster syncs
# Data is sent directly from master to replica over socket
# Faster for slow disks, good for Docker
repl-diskless-sync yes

# Delay before starting diskless transfer (wait for more replicas)
repl-diskless-sync-delay 5

# Maximum time to wait for diskless sync
repl-diskless-sync-max-replicas 0

# Diskless load mode
# 'disabled': use disk-backed loading
# 'on-empty-db': diskless if DB is empty
# 'swapdb': use diskless with temp DB swap (safest)
repl-diskless-load swapdb

# Ping master every N seconds
repl-ping-replica-period 10

# Replication timeout (should be > ping period)
repl-timeout 60

# Disable Nagle algorithm for lower latency
# Critical for real-time systems
repl-disable-tcp-nodelay no

# Replication backlog size
repl-backlog-size 64mb

# Backlog TTL
repl-backlog-ttl 3600

# Replica priority for Sentinel failover
# Lower value = higher priority to become master
# Set to 0 to never be promoted (useful for read replicas)
replica-priority 100

# Propagate errors from master to replica (useful for debugging)
propagation-error-behavior panic

# Ignore disk write errors (not recommended)
replica-ignore-disk-write-errors no

# Announce IP to master (Docker hostname)
# Sentinel needs this for proper discovery
# Will be overridden by container hostname

# -----------------------------------------------------------------------------
# SNAPSHOTTING (RDB PERSISTENCE)
# -----------------------------------------------------------------------------
# Replicas also save RDB snapshots for independent recovery.

save 900 1
save 300 10
save 60 10000

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
rdb-del-sync-files no
dir /data

# -----------------------------------------------------------------------------
# APPEND ONLY FILE (AOF) PERSISTENCE
# -----------------------------------------------------------------------------
# Enable AOF on replicas for durability.

appendonly yes
appendfilename "appendonly.aof"
appenddirname "appendonlydir"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes
aof-timestamp-enabled no

# -----------------------------------------------------------------------------
# MEMORY MANAGEMENT
# -----------------------------------------------------------------------------

maxmemory 1gb
maxmemory-policy volatile-lru
maxmemory-samples 5

# -----------------------------------------------------------------------------
# LAZY FREEING
# -----------------------------------------------------------------------------

lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# -----------------------------------------------------------------------------
# THREADING
# -----------------------------------------------------------------------------

io-threads 4
io-threads-do-reads yes

# -----------------------------------------------------------------------------
# CLIENT SETTINGS
# -----------------------------------------------------------------------------

maxclients 10000
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 64mb 32mb 60

# -----------------------------------------------------------------------------
# SLOW LOG
# -----------------------------------------------------------------------------

slowlog-log-slower-than 10000
slowlog-max-len 128

# -----------------------------------------------------------------------------
# ACTIVE DEFRAGMENTATION
# -----------------------------------------------------------------------------

activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25
active-defrag-max-scan-fields 1000

